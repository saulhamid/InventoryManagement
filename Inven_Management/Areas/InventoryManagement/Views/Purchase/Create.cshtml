@model InventoryViewModel.ViewModel.PurchaseVM
@using UIHelper.MVC
<style>
    .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
 padding:0px!important;
           }
     #ProductCode  {
            width:300px!important;
        }
</style>
@using (Html.BeginForm("Create", "Purchase", FormMethod.Post, new { Id="upform"}))
{ 
    <div class="thinbox">
    <div class="th_thinbox">
        <p>Purchase List</p>
    </div>
                <div class="box-content">
                    <div id="demo1">
                        @Html.ValidationSummary(true)
                        @Html.HiddenFor(model => model.Id, new {  @class = "purcheaseId" })
                        <div class="row" style="">
                            @*<div class="col-md-1">
                                <div class="editor-label">
                                    &nbsp;
                                </div>
                                <div class="editor-field">
                                </div>
                            </div>*@
                            
                            <div class="col-md-2">
                                <div class="editor-label">
                                    @Html.LabelFor(model => model.InvoiecNo)
                                </div>
                                <div class="editor-field">
                                    @Html.TextBoxFor(model => model.InvoiecNo, new { @placeholder = "InvoiecNo", @class = " required form-control" })
                                    @Html.ValidationMessageFor(model => model.InvoiecNo)
                                </div>
                            </div>
                          
                            <div class="col-md-2">
                                <div class="editor-label">
                                    @Html.LabelFor(model => model.SupplierId)
                                </div>
                                <div class="editor-field">
                                    @Html.SimpleDropDownFor(model => model.SupplierId, "/Config/DropDown/Supplier", new { @placeholder = " Product Category Name", @class = " form-control select2" })

                                    @Html.ValidationMessageFor(model => model.SupplierId)
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="editor-label">
                                    @Html.LabelFor(model => model.EmployeeId)
                                </div>
                                <div class="editor-field">
                                    @Html.SimpleDropDownFor(model => model.EmployeeId, "/Config/DropDown/Employee", new { @placeholder = " Product Category Name", @class = " form-control select2" })

                                    @Html.ValidationMessageFor(model => model.EmployeeId)
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="editor-label">
                                    @Html.LabelFor(model => model.Date)
                                </div>
                                <div class="editor-field">
                                    @Html.TextBoxFor(model => model.Date, new { @placeholder = "Date", @class = "customDatePicker required form-control" })
                                    @Html.ValidationMessageFor(model => model.Date)
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="editor-label">
                                    @Html.LabelFor(model => model.Remarks)
                                </div>
                                <div class="editor-field">
                                    @Html.TextAreaFor(model => model.Remarks, new { @placeholder = "Remarks", @class = " form-control" })
                                    @Html.ValidationMessageFor(model => model.Remarks)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    <div class="thinbox">
        <div class="th_thinbox">
            <p>Purchase List</p>
        </div>
        <div id="demo1">

            @Html.ValidationSummary(true)
            <div class="row" style="">
                <div class="col-md-4">
                    <div class="editor-label">
                        @Html.Label("Product Code")
                    </div>
                    <div class="editor-field">
                        @Html.SimpleDropDown("ProductCode", "/Config/DropDown/ProductwithCode", new { @placeholder = " Product Category Name", @class = " form-control select2 code", @style= "width:400px!important;" })
                        @Html.ValidationMessage("Product Code")
                    </div>
                </div>
             
                <div class="col-md-1">
                    <div class="editor-label">
                        @Html.LabelFor(model => model.PurcheaseDetails.FirstOrDefault().Quantity)
                    </div>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.PurcheaseDetails.FirstOrDefault().Quantity, new { @placeholder = "Quantity", @class = "ppqty center  number form-control" })
                        @Html.ValidationMessageFor(model => model.PurcheaseDetails.FirstOrDefault().Quantity)
                    </div>
                </div>
                <div class="col-md-1">
                    <div class="editor-label">
                        @Html.LabelFor(model => model.PurcheaseDetails.FirstOrDefault().UnitePrice)
                    </div>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.PurcheaseDetails.FirstOrDefault().UnitePrice, new { @placeholder = "UnitePrice", @class = "ppunit center number form-control" })
                        @Html.ValidationMessageFor(model => model.PurcheaseDetails.FirstOrDefault().UnitePrice)
                    </div>
                </div>
                <div class="col-md-1">
                    <div class="editor-label">
                        @Html.LabelFor(model => model.PurcheaseDetails.FirstOrDefault().Discount)
                    </div>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.PurcheaseDetails.FirstOrDefault().Discount, new { @placeholder = "Discount", @class = "ppdis center number form-control" })
                        @Html.ValidationMessageFor(model => model.PurcheaseDetails.FirstOrDefault().Discount)
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="editor-label">
                        @Html.LabelFor(model => model.PurcheaseDetails.FirstOrDefault().Remarks)
                    </div>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.PurcheaseDetails.FirstOrDefault().Remarks, new { @placeholder = "Remarks", @class = " form-control" })
                        @Html.ValidationMessageFor(model => model.PurcheaseDetails.FirstOrDefault().Remarks)
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="editor-label">
                        &nbsp;
                    </div>
                    <button type="button" title="Save Data" class="i-btn-add AddRowIndent" id="addrow"> Addrow</button>
                </div>
            </div>
        </div>
    </div>
      
    <table class="table table-responsive table-striped table-hover">
        <thead>
            <tr>
                <th>Action</th>
                <th>Code and Name</th>
                <th>Quantity</th>
                <th>UnitPrice</th>
                <th>Discount</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.PurcheaseDetails)
            {
                Html.RenderPartial("_purcheaseDetail", item);
            }
        </tbody>
        <tfoot>
            <tr>
                <td><b> Total Quantity =</b></td>
                <td><input type="text" readonly="readonly" class="totaolqty right form-control" /></td>
                <td><b>TOtal Discount =</b></td>
                <td><input type="text" readonly="readonly" class=" totaldise right form-control" /></td>
                <td ><b> Total =</b></td>
                <td ><input type="text" readonly="readonly" class="result right form-control" /> </td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td><b>Discount:</b></td>
                <td>
                 @Html.TextBox("Total Discount",null, new { @placeholder = "Total Discount", @class = "right TotalDiscount form-control" })
                 @Html.ValidationMessage("Total Discount")
                </td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td><b>Grand Total</b></td>
                <td><input type="text" readonly="readonly" class="grandTotal right form-control" /></td>
            </tr>
        </tfoot>
    </table>
    <div class="row">
        <div class="col-md-3">
            <div class="editor-label">
                &nbsp;
            </div>
            <div class="editor-field">
                <button type="button" title="Save Data" id="sub" class="i-btn-save"> Save</button>
            </div>
        </div>
    </div>
}
<script>
    $(document).ready(function () {
        $(".select2").select2();
        $(".select2").removeClass("form-control");
        valiDation("upform");
        $(function () {
            if ($(".purcheaseId").val() != null) {
                $("table").show();
            };
        });
        $(".simpledrop").select2();
        calculation();
    });
    function removerow(sender) {
        Ask("Are you sure to delete this file!", function () {
            $(sender).parents("tr.pa:first").remove();
            calculation();
        }, function () { });
    }
         $("table").hide();
                if(
                $("#Code").val()!= '')
                {
                    $("table").show();
                }
                $("#addrow").click(function () {
                    var code = $('.code  :selected').text();
                    code = code.split('-')[0];
                    alert(code);

                    var exit = true;
                    $(".pa").each(function (i, item) {
                        var el = $(this);
                        var tcode = el.closest("tr").find(".pname").val();
                        tcode = tcode.split('~')[0]
                        if (code == tcode || code.toLowerCase() == 'select') {
                            exit = false;
                            ShowResult("this Product Already Add in below List");
                            return;
                        }
                    })
            var Quantity = $(".ppqty").val();
            var UnitePrice = $(".ppunit").val();
            var Discount =getNum($(".ppdis").val());
            var remarks = $("#Productvm_Remarks").val();
            if (code == null) {
                return;
                ShowResult("Plaese Select a product");
            }
            if (Quantity == null || Quantity == '') {
                ShowResult("Enter Quantity");

                return;
            }
            alert(Quantity);
            if (UnitePrice == null || UnitePrice == '') {
                ShowResult("Enter UnitePrice");
                return;
            }
            if (exit == true) {
                var url = "/InventoryManagement/Purchase/ProductDetail?code=" + code + "&Quantity=" + Quantity + "&UnitePrice=" + UnitePrice + "&Discount=" + Discount + "&Remarks=" + remarks;
                $.get(url, function (data) {
                    $("table tbody").append(data);
                    $("table").show();
                    calculation();
                    blackfield();
                });
            }
                });
                function blackfield() {
                    $(".Name").val('');
                    $(".code").val('');
                    $(".ppqty").val('');
                    $(".ppunit").val('');
                    $(".ppdis").val('');
                    $("#Remarks").val("");

                }
                blackfield();
        $(".Edit-row").click(function () {
            calculation();
        });
        $("#sub").click(function () {
            var datas = $("#upform").serialize();
            var url = $("form").attr("action");
            if (pageSubmitJSON('upform') == 0) {
                $.post(url, datas, function (data, status) {
                    window.location.reload();
                    if (status == "success") {
                        ShowResult(data);
                    }
                });
         };
        });
        $(".TotalDiscount,.grandTotal").change(function () {
            calculation();
        });
        function calculation() {
            var result= 0;
            var totaolqty = 0;
            var totaldise = 0;
            var ttotal = 0;
            var tdis = getNum($(".TotalDiscount").val());

            $(".pa").each(function (i, item) {
                var el = $(this);
                var qty, unit, disc, amount = 0;
                qty = getNum(el.closest("tr").find(".qty").val());
                unit = getNum(el.closest("tr").find(".unit").val());
                disc =getNum( el.closest("tr").find(".disc").val());
                amount = (parseFloat(qty) * parseFloat(unit)) - parseFloat(disc);
                el.closest("tr").find(".amount").val(amount);
                totaolqty += parseFloat(qty);
                totaldise += parseFloat(disc);
                result += getNum(amount);
                
            });
            $('.result').val(result);
            $('.totaolqty').val(getNum(totaolqty));

            $('.totaldise').val(getNum(totaldise));

            ttotal = result - parseFloat(tdis);
          
            $(".grandTotal").val(getNum(ttotal));
        }
        $('.qty,.unit,.disc').keyup(function () {
            calculation();
        });
    $(".number").change(function () {
        if (!$.isNumeric($(this).val())) {
            $(this).val(0);
            ShowResult("this not be Numeric");
        }
    });
    function getNum(val) {
        if (isNaN(val) || val == null || val == '' || typeof val == 'undefined') {
            return 0;
        }
        return val;
    }
    function pageSubmitJSON(sender) {
        var a = 0;
        for (var i = 0; i < $('#' + sender + ' .required').length; i++) {
            if ($($('#' + sender + ' .required')[i]).val() == "") {
                $($('#' + sender + ' .required')[i]).parent().find('.RequiredField').show();
                a++;
            }
        }
        return a;
    }
    function EditRow(send) {
        $(".code").val($(send).parents().parents().children().find(".pname").val());
        $(".Name").val($(send).parents().parents().children().find(".pname").val());
        $(".ppqty").val($(send).parents().parents().children().find(".qty").val());
        $(".ppunit").val($(send).parents().parents().children().find(".unit").val());
        $(".ppdis").val($(send).parents().parents().children().find(".disc").val());
        $(send).closest('.pa').remove();
        calculation();
    };
</script>



